<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />

    <title>Choir Attendance</title>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">Choir Attendance</a>
        </div>
      </div>
    </nav>
    <div class="py-5"></div>
    <div class="container">
      <h6 class="d-inline-block ml-auto mb-2 text-right">
        Details Entered: <span id="attendanceCount"></span>
      </h6>

      <form id="mainForm">
        <div class="mb-3">
          <label for="regNo" class="form-label">Registration Number</label>
          <input
            type="number"
            class="form-control"
            id="regNo"
            aria-describedby="regNoHelp"
          />
          <div id="regNoHelp" class="form-text">
            You'll need to enter your reg no for today's attendance
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
      <hr class="my-5" />
      <table class="table mb-5">
        <thead>
          <tr>
            <th scope="col">Day</th>
            <th scope="col">Number</th>
            <th scope="col">Code</th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <form id="rowForm">
        <div class="mb-3 d-flex align-items-center">
          <input
            class="form-control"
            id="day"
            name="day"
            aria-describedby="dayHelp"
            style="max-width: 200px"
          />
          <button
            style="width: 100px; margin-left: 5px"
            type="submit"
            class="btn btn-primary"
          >
            Add Row
          </button>
        </div>
      </form>
    </div>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script>
      const today = new Date();
      const [day, month, year] = [
        today.getUTCDate(),
        today.getMonth(),
        today.getFullYear(),
      ];
      const attDay = `${day}-${month}-${year}`;
      const addData = (key, val) =>
        localStorage.setItem(key, JSON.stringify(val));
      const getData = (key) =>
        localStorage.getItem(key)
          ? JSON.parse(localStorage.getItem(key))
          : localStorage.getItem(key);

      if (!getData(attDay)) addData(attDay, []);
      if (!getData("knownDays")) addData("knownDays", [attDay]);

      const allData = { [attDay]: getData(attDay) };

      const addRow = (day, length) => {
        const tableBody = document.getElementById("tableBody");
        tableBody.innerHTML += `<tr>
          <th scope="row">${day}</th>
          <td>${length}</td>
          <td>
            <div style="max-width: 100px" class="input-group">
              <input
              type="text"
              class="form-control"
              placeholder="code"
              aria-label="code"
              aria-describedby="basic-addon1"
              />
              </div>
              </td>
              <td>
                <button type="button" class="btn btn-primary">Upload</button>
                </td>
                </tr>`;
      };

      const populateKnownDays = () => {
        const knownDays = getData("knownDays");
        knownDays.map((day) => addRow(day, getData(day).length));
      };
      populateKnownDays();
      
      const addRowIfDay = (event) => {
        event.preventDefault();
        const formData = new FormData(event.target);
        const formDay = formData.get("day");
        if (!getData(formDay)) {
          return swal("Error", "Could not load day", "error");
        }
        if (getData("knownDays").includes(formDay)) {
          return swal("Error", "Day already added", "error");
        }
        addData("knownDays", [...getData("knownDays"), formDay]);
        populateKnownDays();
      };
      document.getElementById("rowForm").onsubmit = addRowIfDay;

      const regInput = document.getElementById("regNo");
      const countEl = document.getElementById("attendanceCount");
      const form = document.getElementById("mainForm");

      countEl.innerHTML = getData(attDay).length;

      const handleForm = (e) => {
        e.preventDefault();
        const reg_no = regInput.value;
        if (reg_no.length !== 7) {
          swal("Error", "Invalid reg no", "error");
          return;
        }
        // Clear input
        regInput.value = "";
        if (getData(attDay).includes(reg_no)) {
          alert("Duplicate reg no");
          return;
        }
        addData(attDay, [...getData(attDay), reg_no]);
        // Note count
        countEl.innerHTML = getData(attDay).length;
      };

      form.onsubmit = handleForm;
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
